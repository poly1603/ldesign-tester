# @ldesign/tester 使用指南

> 🧪 企业级测试工具集 - 一键生成测试、Mock、配置和CI/CD

## 📦 这个包是做什么的？

@ldesign/tester 是一个**完整的测试解决方案**，它能帮你：

1. **自动生成测试代码** - 单元测试、E2E测试、组件测试、API测试
2. **生成Mock数据** - Faker.js假数据 + MSW API Mock
3. **生成测试配置** - Vitest/Playwright零配置启动
4. **生成CI/CD配置** - GitHub Actions/GitLab CI/Jenkins模板
5. **性能和视觉测试** - Benchmark/压力测试/Screenshot对比

**简单来说**：不用手写测试代码和配置，全部自动生成！

## 🚀 快速开始（3步）

### 1. 安装

```bash
pnpm add -D @ldesign/tester
```

### 2. 初始化

```bash
npx ldesign-test init
```

这会自动：
- ✅ 生成 `vitest.config.ts`
- ✅ 生成 `tests/setup.ts`
- ✅ 生成 `tsconfig.test.json`

### 3. 生成测试

```bash
# 为函数生成单元测试
npx ldesign-test generate unit UserService

# 为Vue组件生成测试
npx ldesign-test generate component Button --framework vue

# 为React组件生成测试
npx ldesign-test generate component Button --framework react
```

## 🎯 主要功能

### 1. 测试生成

#### 单元测试

```bash
npx ldesign-test generate unit utils/format
```

生成的测试包含：
- ✅ 基本功能测试
- ✅ 边界条件测试
- ✅ 错误处理测试

#### Vue组件测试

```bash
npx ldesign-test generate component MyButton --framework vue
```

生成的测试包含：
- ✅ 组件渲染测试
- ✅ Props测试
- ✅ 事件测试
- ✅ 插槽测试

#### React组件测试

```bash
npx ldesign-test generate component MyButton --framework react
```

生成的测试包含：
- ✅ 组件渲染测试
- ✅ Props测试
- ✅ 用户交互测试
- ✅ Children测试

#### E2E测试

```bash
npx ldesign-test generate e2e login
```

生成的测试包含：
- ✅ 页面加载测试
- ✅ 用户交互测试
- ✅ 表单提交测试

### 2. Mock系统

#### 生成Faker假数据

```bash
# 生成10个用户
npx ldesign-test mock faker --type user --count 10

# 生成20个产品
npx ldesign-test mock faker --type product --count 20

# 生成订单数据
npx ldesign-test mock faker --type order --count 15
```

#### 生成MSW API Mock

```bash
# 为users资源生成CRUD handlers
npx ldesign-test mock msw --resource users

# 输出到指定文件
npx ldesign-test mock msw --resource posts --output src/mocks/posts.ts
```

#### 编程方式使用

```typescript
import { createMockGenerator } from '@ldesign/tester'

const mockGen = createMockGenerator()

// 生成用户数据
const users = mockGen.generateCommonData('user', 10, 'zh_CN')

// 生成产品数据
const products = mockGen.generateCommonData('product', 20)
```

### 3. 配置生成

#### Vitest配置

```bash
npx ldesign-test config vitest --coverage
```

生成包含：
- ✅ 测试环境配置（jsdom）
- ✅ 覆盖率配置（v8）
- ✅ Vue/React插件配置

#### Playwright配置

```bash
npx ldesign-test config playwright
```

生成包含：
- ✅ 多浏览器配置（Chrome/Firefox/Safari）
- ✅ 移动端配置
- ✅ 截图/录屏配置

### 4. CI/CD集成

#### GitHub Actions

```bash
npx ldesign-test ci github --node-versions 18,20 --coverage
```

生成 `.github/workflows/test.yml`，包含：
- ✅ 多Node版本矩阵测试
- ✅ 覆盖率上传到Codecov
- ✅ 测试结果Artifacts

#### GitLab CI

```bash
npx ldesign-test ci gitlab
```

生成 `.gitlab-ci.yml`，包含：
- ✅ Pipeline配置
- ✅ 覆盖率报告
- ✅ GitLab Pages部署

#### Jenkins

```bash
npx ldesign-test ci jenkins
```

生成 `Jenkinsfile`，包含：
- ✅ 声明式Pipeline
- ✅ HTML报告发布

### 5. 性能测试

#### 基准测试

```typescript
import { createBenchmarkTester } from '@ldesign/tester'

const tester = createBenchmarkTester()

tester
  .add({
    name: 'Array.forEach',
    fn: () => { /* ... */ },
  })
  .add({
    name: 'for loop',
    fn: () => { /* ... */ },
  })

const results = await tester.run()
console.log(tester.formatResults(results))
```

输出：
```
📊 基准测试结果
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. Array.forEach
   ⚡ Ops/sec: 1,234,567.89
   ⏱️  平均耗时: 0.0008ms
   
2. for loop
   ⚡ Ops/sec: 2,345,678.90
   ⏱️  平均耗时: 0.0004ms

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 压力测试

```typescript
import { createLoadTester } from '@ldesign/tester'

const loadTester = createLoadTester()

const result = await loadTester.runLoadTest({
  url: 'http://localhost:3000/api/users',
  connections: 100,
  duration: 30,
})

console.log(loadTester.formatResult(result))
```

#### Lighthouse测试

```typescript
import { createLighthouseTester } from '@ldesign/tester'

const lighthouse = createLighthouseTester()

const result = await lighthouse.runLighthouse({
  url: 'https://example.com',
  formFactor: 'mobile',
})

console.log(lighthouse.formatResult(result))
```

### 6. 视觉回归测试

#### Screenshot对比

```typescript
import { createVisualRegression } from '@ldesign/tester'

const visualRegression = createVisualRegression()

test('visual regression', async ({ page }) => {
  await page.goto('https://example.com')
  
  const result = await visualRegression.captureAndCompare(
    page,
    'homepage',
  )
  
  expect(result.hasDiff).toBe(false)
})
```

#### Percy集成

```typescript
import { createPercyIntegration } from '@ldesign/tester'

const percy = createPercyIntegration()

test('percy snapshot', async ({ page }) => {
  await page.goto('https://example.com')
  
  await percy.snapshot(page, {
    name: 'Homepage',
    widths: [375, 768, 1280],
  })
})
```

## 📊 Dashboard

### 启动Dashboard

```bash
npx ldesign-test dashboard --port 3000
```

访问 `http://localhost:3000` 查看：
- 测试运行历史
- 覆盖率趋势
- 失败用例追踪
- 性能统计

### 编程方式

```typescript
import { createDashboardServer, createTestDatabase } from '@ldesign/tester'

const db = createTestDatabase()
const runId = db.saveTestRun(results, coverage)

const dashboard = createDashboardServer({ port: 3000 })
await dashboard.start()
```

## 🔧 所有CLI命令

```bash
# 初始化
npx ldesign-test init [--framework vue|react] [--coverage] [--e2e]

# 生成脚手架
npx ldesign-test scaffold

# 生成测试
npx ldesign-test generate unit <name>
npx ldesign-test generate component <name> --framework vue|react
npx ldesign-test generate e2e <feature>
npx ldesign-test generate api <name>
npx ldesign-test generate integration <name>

# Mock
npx ldesign-test mock faker --type user|product|order [--count 10] [--locale zh_CN|en_US]
npx ldesign-test mock msw --resource <name> [--output <path>]

# 配置
npx ldesign-test config vitest [--coverage]
npx ldesign-test config playwright

# CI/CD
npx ldesign-test ci github [--node-versions 18,20] [--coverage]
npx ldesign-test ci gitlab
npx ldesign-test ci jenkins
npx ldesign-test ci circleci

# 性能
npx ldesign-test benchmark [files...]

# Dashboard
npx ldesign-test dashboard [--port 3000]

# 覆盖率
npx ldesign-test coverage [--threshold 80]
```

## 📖 完整API

### TestGenerator

```typescript
import { createTestGenerator } from '@ldesign/tester'

const generator = createTestGenerator()

// 单元测试
const unitTest = generator.generateUnitTest('UserService')

// 组件测试
const vueTest = generator.generateComponentTest('Button', 'vue')
const reactTest = generator.generateComponentTest('Button', 'react')

// E2E测试
const e2eTest = generator.generateE2ETest('login')

// API测试
const apiTest = generator.generateAPITest('users')
```

### ConfigGenerator

```typescript
import { createConfigGenerator } from '@ldesign/tester'

const configGen = createConfigGenerator()

// Vitest配置
const vitestConfig = configGen.generateVitestConfig({
  environment: 'jsdom',
  coverage: { provider: 'v8' },
})

// Playwright配置
const playwrightConfig = configGen.generatePlaywrightConfig({
  baseURL: 'http://localhost:3000',
})
```

### MockGenerator

```typescript
import { createMockGenerator } from '@ldesign/tester'

const mockGen = createMockGenerator()

// Faker数据
const users = mockGen.generateCommonData('user', 10, 'zh_CN')

// MSW Handler
const handler = mockGen.generateMSWHandler({
  method: 'GET',
  path: '/api/users',
  response: users,
})
```

## 💡 最佳实践

### 1. 项目结构

```
your-project/
├── src/
│   ├── components/
│   ├── utils/
│   └── api/
├── tests/
│   ├── unit/           # 单元测试
│   ├── integration/    # 集成测试
│   ├── helpers/        # 测试工具
│   ├── fixtures/       # 测试数据
│   └── mocks/          # Mock文件
├── e2e/                # E2E测试
├── vitest.config.ts
└── playwright.config.ts
```

### 2. package.json脚本

```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest run --coverage",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "dashboard": "ldesign-test dashboard"
  }
}
```

### 3. Git忽略

```gitignore
# 测试相关
coverage/
test-results/
playwright-report/
.nyc_output/
test-history.db
```

## ❓ 常见问题

### Q: 支持哪些测试框架？

A: 主要支持 Vitest（单元/组件）和 Playwright（E2E），也支持Jest（通过兼容API）。

### Q: 支持哪些前端框架？

A: Vue 3 和 React 18+。

### Q: 可以自定义生成的测试代码吗？

A: 可以，通过配置选项或者修改生成后的代码。

### Q: Mock数据支持哪些类型？

A: 支持30+字段类型，包括name、email、phone、address、uuid、date等。

### Q: CI/CD模板可以修改吗？

A: 可以，生成后可以根据需要修改。

## 🔗 相关链接

- [Vitest](https://vitest.dev/)
- [Playwright](https://playwright.dev/)
- [Faker.js](https://fakerjs.dev/)
- [MSW](https://mswjs.io/)
- [完整文档](./docs/)

## 📄 License

MIT © LDesign Team

---

**一句话总结**：@ldesign/tester = 测试生成 + Mock系统 + 配置生成 + CI/CD模板 + 性能测试 + 视觉回归 + Dashboard

**核心价值**：让你写更少的测试代码，得到更好的测试覆盖率！🚀



